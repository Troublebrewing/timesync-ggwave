<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>TimeSync-Flash</title>
    <style>
        html, body {
            font-family: Arial, sans-serif;
            text-align: center;
            margin-top: 10%;
            font-size: 1.5rem;
            height: 100%;
            padding: 0;
            margin: 0;
            background-color: black;
        }
        
        button {
            font-size: 1rem;
            padding: 10px 20px;
            margin-top: 20px;
            background-color: aqua;
            margin: auto;
            border-radius: 15px
        }
        .top-right {
            position: absolute;
            top: 10px;
            right: 10px;
        }
        #title {
            color: white;
            /*background-color: black;*/
            height: 10%
            padding: 0;
            margin: 0;
        }
        #button-div {
            width: 100%;
            height: 90%;
            /*background-color: black;*/
            margin: auto;
            cursor: pointer;
            line-height: 400px;
            color: white;
            font-size: 2rem;
            user-select: none;
        }
        #warning {
            font-size: 1rem;
            color: white;
            margin-top: 20px;
        }
    </style>
</head>
<body id="body">

    
    <a class="top-right" href="https://github.com/Troublebrewing/timesync-flash" target="_blank">
        <img src="https://img.shields.io/github/stars/Troublebrewing/timesync-flash?style=social"
                alt="GitHub Repo Stars"></a>

    <h1 id="title">TimeSync-Flash</h1>
    
    <div id="button-div">
        <div>Tap to set time</div>
        <div id="warning">WARNING: FLASHING LIGHTS</div>
    </div>       


        
    

    

    

    <script>
        function togglebg() {
            const body = document.body;
            body.style.backgroundColor = body.style.backgroundColor === 'black' ? 'white' : 'black';
            const buttonDiv = document.getElementById("button-div");
            buttonDiv.style.color = buttonDiv.style.color === 'white' ? 'black' : 'white';
            const title = document.getElementById("title");
            title.style.color = title.style.color === 'white' ? 'black' : 'white';
        }

        function sync(duration=20) {
            const out = [];
            for (let i = 0; i < duration; i++) {
                out.push(1);
            }
            out.push(0);  // Indicates end of sync period
            return out;
        }
			
        function dataWord(data) {
            const out = [];
            for (let by = 0; by < 4; by++) {
                const dataByte = (data >> (by*8)) & 0xFF;
                for (let bi = 7; bi >= 0; bi--) {
                    out.push((dataByte >> bi) & 1);
                }
            }
            return out;
        }
        
        function dataDateTime(dateTime) {
            const tzOffset = dateTime.getTimezoneOffset() * 60;
            const unixTime = ((dateTime.getTime() / 1000) - tzOffset) | 0;
            return dataWord(unixTime)
        }

        function toFrames(bits) {
            const out = [];
            for (const bit of bits) {
                out.push(bit ^ 1);
                out.push(bit);
            }
            return out;
        }

        class Flasher {
            constructor(bg_element, fg_elements, fps=30) {
                this.fg_elements = fg_elements;
                this.bg_element = bg_element;
                this.frames = [];
                this.nextFrame = 0;
                this.period = 1000 / fps;
            }
            
            _playFrame() {
                if (performance.now() >= this.nextFrame) {
                    this.nextFrame += this.period;
                    
                    const state = this.frames.shift();
                    //this.element.style.backgroundColor = state ? "white" : "black";

                    //this.bg_element.style.backgroundColor = this.bg_element.style.backgroundColor === 'black' ? 'white' : 'black';
                    this.bg_element.style.backgroundColor = this.bg_element.style.backgroundColor === 'white' ? 'black' : 'white';
                    for (const fg_element of this.fg_elements) {
                        fg_element.style.color = this.bg_element.style.backgroundColor;
                    }
                }
                if (this.frames.length > 0) {
                    requestAnimationFrame(this._playFrame.bind(this));
                }else{
                    this.resetFGElements();
                }
            }
            
            isPlaying() {
                return this.frames.length != 0;
            }

            resetFGElements() {
                for (const fg_element of this.fg_elements) {
                    fg_element.style.color = 'white';
                }
                this.bg_element.style.backgroundColor = 'black';
            }
            
            play(frames) {
                if (!this.isPlaying()) {
                    requestAnimationFrame(this._playFrame.bind(this));
                }
                this.frames = frames;
                this.nextFrame = performance.now();
            }
            
            stop(frames) {
                this.play([0]);
            }
        }

        function taphandler() {
            const bg_element = document.body;
            const fg_elements = [
                document.getElementById("button-div"),
                document.getElementById("title"),
                document.getElementById("warning"),
            ];
			const flasher = new Flasher(bg_element, fg_elements);
            
            const syncLength = 20;
            const syncDuration = flasher.period * 2 * (syncLength + 1);
            const now = new Date();
            const sync_data = sync(syncLength);
            const offsetnow_data = dataDateTime(now);

            flasher.play(toFrames([...sync(syncLength), ...dataDateTime(now)]));
        }

        document.getElementById("button-div")
            .addEventListener("click", taphandler);
    </script>

</body>
</html>
