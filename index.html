<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>TimeSync-ggwave</title>
    <style>
        html, body {
            font-family: Arial, sans-serif;
            text-align: center;
            margin-top: 10%;
            font-size: 1.5rem;
            height: 100%;
            padding: 0;
            margin: 0;
            background-color: black;
        }
        
        button {
            font-size: 1rem;
            padding: 10px 20px;
            margin-top: 20px;
            background-color: aqua;
            margin: auto;
            border-radius: 15px
        }
        .top-right {
            position: absolute;
            top: 10px;
            right: 10px;
        }
        #title {
            color: white;
            /*background-color: black;*/
            height: 10%;
            padding: 0;
            margin: 0;
        }
        #button-div {
            width: 100%;
            height: 90%;
            /*background-color: black;*/
            margin: auto;
            cursor: pointer;
            line-height: 400px;
            color: white;
            font-size: 2rem;
            user-select: none;
        }

    </style>
</head>
<body id="body">

    
    <a class="top-right" href="https://github.com/Troublebrewing/timesync-ggwave" target="_blank">
        <img src="https://img.shields.io/github/stars/Troublebrewing/timesync-ggwave?style=social"
                alt="GitHub Repo Stars"></a>

    <h1 id="title">TimeSync-ggwave</h1>
    
    <div id="button-div">Tap to set time</div>     
    
    <script type="text/javascript" src="https://ggwave-js.ggerganov.com/ggwave.js"></script>
    <script type="text/javascript" src="ggwave.js"></script>
    <script type='text/javascript'>
        window.AudioContext = window.AudioContext || window.webkitAudioContext;
        window.OfflineAudioContext = window.OfflineAudioContext || window.webkitOfflineAudioContext;

        var context = null;
        //var recorder = null;

        // the ggwave module instance
        var ggwave = null;
        var parameters = null;
        var instance = null;

        // instantiate the ggwave instance
        // ggwave_factory comes from the ggwave.js module
        ggwave_factory().then(function(obj) {
            ggwave = obj;
        });

        function OffsetDateTime(dateTime) {
            const tzOffset = dateTime.getTimezoneOffset() * 60;
            const offsetunixTime = ((dateTime.getTime() / 1000) - tzOffset) | 0;
            return offsetunixTime;
        }

        // helper function
        function convertTypedArray(src, type) {
            var buffer = new ArrayBuffer(src.byteLength);
            var baseView = new src.constructor(buffer).set(src);
            return new type(buffer);
        }

        // initialize audio context and ggwave
        function init() {
            if (!context) {
                context = new AudioContext({sampleRate: 48000});

                parameters = ggwave.getDefaultParameters();
                parameters.sampleRateInp = context.sampleRate;
                parameters.sampleRateOut = context.sampleRate;
                instance = ggwave.init(parameters);
            }
        }

        //
        // Tx
        //

        function onSend() {
            init();

            var now = new Date();
            var offsetnowdata = OffsetDateTime(now).toString();

            // generate audio waveform
            var waveform = ggwave.encode(instance, offsetnowdata, ggwave.ProtocolId.GGWAVE_PROTOCOL_AUDIBLE_FAST, 10)

            // play audio
            var buf = convertTypedArray(waveform, Float32Array);
            var buffer = context.createBuffer(1, buf.length, context.sampleRate);
            buffer.getChannelData(0).set(buf);
            var source = context.createBufferSource();
            source.buffer = buffer;
            source.connect(context.destination);
            source.start(0);
        }

        document.getElementById("button-div")
            .addEventListener("click", onSend);
    </script>
</body>
</html>
